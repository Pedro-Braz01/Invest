<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Simulador Avan√ßado ‚Äî Im√≥veis & Investimentos</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
/* ‚îÄ‚îÄ‚îÄ DESIGN SYSTEM ORIGINAL (PREMIUM DARK) ‚îÄ‚îÄ‚îÄ */
:root {
  --bg-base:      #0f1117;
  --bg-sidebar:   #12141c;
  --bg-card:      #161822;
  --bg-card2:     #1c1f2e;
  --bg-input:     #13151f;
  --accent:       #00d4aa;       /* Verde Neon Original */
  --accent-dim:   rgba(0,212,170,.15);
  --accent2:      #5b8cf5;       /* Azul Original */
  --accent2-dim:  rgba(91,140,245,.15);
  --warn:         #f5a623;
  --danger:       #ef5350;
  --text:         #e2e4ea;
  --text-muted:   #7a7f95;
  --border:       #252838;
  --radius:       12px;
  --shadow:       0 4px 24px rgba(0,0,0,.35);
  --font:         'Segoe UI', system-ui, sans-serif;
  --sidebar-w:    280px;
}
*, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
html { scroll-behavior:smooth; }
body { font-family:var(--font); background:var(--bg-base); color:var(--text); min-height:100vh; overflow-x:hidden; display:flex; flex-direction:column; }

/* ‚îÄ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ‚îÄ */
.header {
  height: 70px; background:var(--bg-card); border-bottom:1px solid var(--border);
  display:flex; align-items:center; padding:0 24px; position:sticky; top:0; z-index:50;
  backdrop-filter:blur(10px); justify-content:space-between;
}
.header-left { display:flex; align-items:center; gap:16px; }
.brand { display:flex; align-items:center; gap:12px; }
.brand-icon { 
  width:40px; height:40px; background:linear-gradient(135deg, var(--accent), var(--accent2)); 
  border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:20px; 
  box-shadow:0 0 15px rgba(0,212,170,0.3);
}
.brand-text h1 { font-size:1.1rem; font-weight:700; letter-spacing:-0.5px; line-height:1.2; }
.brand-text span { font-size:0.75rem; color:var(--text-muted); font-weight:500; }

.header-right { display:flex; align-items:center; gap:15px; }
.selic-badge { 
  background:var(--accent-dim); border:1px solid var(--accent); color:var(--accent); 
  padding:6px 14px; border-radius:30px; font-size:0.8rem; font-weight:600; display:flex; gap:6px;
}

/* ‚îÄ‚îÄ‚îÄ HAMBURGER & SIDEBAR ‚îÄ‚îÄ‚îÄ */
.hamburger-btn { background:none; border:none; color:var(--text); font-size:24px; cursor:pointer; padding:5px; transition:.2s; }
.hamburger-btn:hover { color:var(--accent); }

.sidebar-overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:90; 
  opacity:0; pointer-events:none; transition:.3s;
}
.sidebar-overlay.open { opacity:1; pointer-events:auto; }

.sidebar {
  position:fixed; top:0; left:calc(var(--sidebar-w) * -1); width:var(--sidebar-w); height:100vh;
  background:var(--bg-sidebar); border-right:1px solid var(--border); z-index:100;
  transition:left .3s cubic-bezier(0.4, 0, 0.2, 1); padding:20px 0; overflow-y:auto;
  box-shadow:4px 0 25px rgba(0,0,0,0.5);
}
.sidebar.open { left:0; }

.sb-header { padding:0 24px 20px; border-bottom:1px solid var(--border); margin-bottom:10px; font-size:1.1rem; font-weight:700; color:var(--text); display:flex; justify-content:space-between; align-items:center;}
.sb-close { background:none; border:none; color:var(--text-muted); font-size:1.5rem; cursor:pointer; }

/* Menu Tree Structure */
.sb-group { padding:0 12px; }
.sb-item-header { 
  padding:10px 12px; color:var(--text-muted); font-size:0.75rem; font-weight:700; 
  text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; gap:8px; 
}
.sb-subgroup { margin-left:12px; padding-left:12px; border-left:1px solid var(--border); }
.sb-link {
  display:flex; align-items:center; gap:10px; width:100%; padding:10px 14px;
  background:transparent; border:none; color:var(--text); text-align:left;
  font-size:0.9rem; cursor:pointer; border-radius:8px; margin-bottom:4px; transition:.2s;
}
.sb-link:hover { background:var(--bg-card2); color:var(--accent); }
.sb-link.active { background:linear-gradient(90deg, var(--accent-dim), transparent); color:var(--accent); font-weight:600; border-left:3px solid var(--accent); border-radius:0 8px 8px 0; }

/* ‚îÄ‚îÄ‚îÄ MAIN CONTENT ‚îÄ‚îÄ‚îÄ */
.container { max-width:1100px; margin:0 auto; padding:30px 20px; width:100%; flex:1; }

/* Tabs (Hidden visually, controlled by JS) */
.tab-panel { display:none; animation:fadeUp 0.4s ease; }
.tab-panel.active { display:block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

/* Cards & Grid */
.card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; margin-bottom:24px; box-shadow:var(--shadow); position:relative; overflow:hidden; }
.card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px; }
.card-title { font-size:1.1rem; font-weight:600; color:var(--accent); display:flex; align-items:center; gap:10px; }
.card-title i { font-style:normal; font-size:1.3rem; }

.grid { display:grid; gap:20px; }
.grid-2 { grid-template-columns:1fr 1fr; }
.grid-3 { grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); }

/* Inputs */
.input-group label { display:block; font-size:0.75rem; color:var(--text-muted); margin-bottom:6px; font-weight:600; letter-spacing:0.5px; }
.input-group input, .input-group select { 
  width:100%; background:var(--bg-input); border:1px solid var(--border); 
  border-radius:8px; padding:12px; color:var(--text); font-size:0.95rem; outline:none; transition:.2s; 
}
.input-group input:focus, .input-group select:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-dim); }
.helper { font-size:0.7rem; color:var(--text-muted); margin-top:4px; }
.helper strong { color:var(--accent); }

/* Export Button */
.export-wrap { position:relative; }
.btn-export { background:var(--bg-card2); color:var(--text); border:1px solid var(--border); padding:8px 16px; border-radius:8px; cursor:pointer; font-weight:600; display:flex; align-items:center; gap:8px; transition:.2s; }
.btn-export:hover { border-color:var(--accent); color:var(--accent); }
.export-menu { position:absolute; top:110%; right:0; background:var(--bg-card); border:1px solid var(--border); border-radius:8px; padding:5px; display:none; flex-direction:column; width:200px; box-shadow:var(--shadow); z-index:50; }
.export-menu.open { display:flex; }
.export-menu button { background:none; border:none; color:var(--text); padding:10px; text-align:left; cursor:pointer; border-radius:5px; font-size:0.85rem; }
.export-menu button:hover { background:var(--bg-card2); color:var(--accent); }

/* Table */
.table-container { overflow-x:auto; border:1px solid var(--border); border-radius:8px; }
table { width:100%; border-collapse:collapse; font-size:0.85rem; }
th { background:var(--bg-card2); color:var(--text-muted); padding:12px; text-align:right; font-weight:600; font-size:0.75rem; text-transform:uppercase; white-space:nowrap; }
th:first-child { text-align:left; }
td { padding:12px; border-bottom:1px solid var(--border); text-align:right; color:var(--text); }
td:first-child { text-align:left; font-weight:600; color:var(--accent); }
tr:hover td { background:rgba(255,255,255,0.02); }

/* KPIs */
.kpi-row { display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px; margin-bottom:20px; }
.kpi { background:var(--bg-card2); padding:15px; border-radius:10px; border:1px solid var(--border); text-align:center; }
.kpi-label { font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; margin-bottom:5px; }
.kpi-val { font-size:1.3rem; font-weight:700; color:var(--text); }
.kpi.green .kpi-val { color:var(--accent); }
.kpi.blue .kpi-val { color:var(--accent2); }

/* ‚îÄ‚îÄ‚îÄ SPECIAL: INVESTIR -> SACAR ‚îÄ‚îÄ‚îÄ */
.is-section-title { color:var(--accent); font-size:0.9rem; font-weight:700; text-transform:uppercase; margin-bottom:15px; display:flex; align-items:center; gap:8px; border-left:3px solid var(--accent); padding-left:10px; }
.is-preview-box { background:var(--bg-card2); border-radius:8px; padding:15px; margin-top:10px; font-size:0.9rem; border:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.is-preview-box .val { font-size:1.1rem; font-weight:700; color:var(--accent); }

.btn-simulate { 
  width:100%; background:linear-gradient(90deg, var(--accent), #00b894); color:#000; font-weight:700; 
  padding:15px; border:none; border-radius:10px; font-size:1rem; cursor:pointer; margin-top:20px;
  box-shadow:0 0 20px rgba(0,212,170,0.3); transition:.2s;
}
.btn-simulate:hover { transform:translateY(-2px); box-shadow:0 0 30px rgba(0,212,170,0.5); }

/* How it works Box */
.how-it-works { background:rgba(0,0,0,0.2); border:1px solid var(--border); border-radius:10px; padding:20px; margin-top:30px; }
.how-header { display:flex; align-items:center; gap:10px; font-weight:700; color:var(--text); margin-bottom:15px; cursor:pointer; }
.how-content { font-size:0.85rem; line-height:1.6; color:var(--text-muted); }
.how-content p { margin-bottom:10px; }
.formula-box { background:var(--bg-card); padding:10px; border-left:3px solid var(--accent2); margin:10px 0; font-family:monospace; color:var(--text); }
.step-list { list-style:none; margin-left:5px; }
.step-list li { position:relative; padding-left:25px; margin-bottom:12px; }
.step-list li::before { 
  content:attr(data-step); position:absolute; left:0; top:2px; width:18px; height:18px; 
  background:var(--accent2); color:#fff; font-size:10px; border-radius:50%; 
  display:flex; align-items:center; justify-content:center; font-weight:bold; 
}
.example-box { background:rgba(0,212,170,0.05); border:1px solid var(--accent-dim); padding:15px; border-radius:8px; margin-top:15px; color:var(--text); }

/* Cycle Log */
.cycle-log { max-height:200px; overflow-y:auto; margin-top:15px; border-top:1px solid var(--border); }
.cycle-item { padding:10px; border-bottom:1px solid var(--border); font-size:0.85rem; display:flex; justify-content:space-between; }
.cycle-item span { color:var(--accent); font-weight:bold; }

/* Responsive */
@media(max-width:768px){ 
  .grid-2, .grid-3 { grid-template-columns:1fr; } 
  .header-right span { display:none; } /* hide labels mobile */
}
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <button class="hamburger-btn" onclick="toggleSidebar()">‚ò∞</button>
    <div class="brand">
      <div class="brand-icon">üìä</div>
      <div class="brand-text">
        <h1>Calculadora de Im√≥veis</h1>
        <span>Amortiza√ß√£o & Investimentos</span>
      </div>
    </div>
  </div>
  <div class="header-right">
    <div class="selic-badge">Selic: <span id="selicTop">13.75%</span></div>
    <div class="export-wrap">
      <button class="btn-export" onclick="toggleExport()">üì§ Exportar</button>
      <div class="export-menu" id="exportMenu">
        <button onclick="exportCSV()">üìÑ CSV (Excel)</button>
        <button onclick="exportExcelXML()">üìó Excel (Nativo)</button>
        <button onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
      </div>
    </div>
  </div>
</header>

<div class="sidebar-overlay" id="sbOverlay" onclick="toggleSidebar()"></div>
<nav class="sidebar" id="sidebar">
  <div class="sb-header">
    üìä Menu
    <button class="sb-close" onclick="toggleSidebar()">√ó</button>
  </div>
  
  <div class="sb-group">
    <div class="sb-item-header">üè† Calculadoras</div>
    <div class="sb-subgroup">
      <div class="sb-item-header" style="padding-left:0; color:var(--accent2);">üè° Im√≥veis</div>
      <button class="sb-link active" onclick="nav('simulador', this)">üìã Simulador de Amortiza√ß√£o</button>
      <button class="sb-link" onclick="nav('comparativo', this)">üìä Investir vs Amortizar</button>
      <button class="sb-link" onclick="nav('oportunidade', this)">üí° Custo de Oportunidade</button>
      <button class="sb-link" onclick="nav('aluguel', this)">üè† Aluguel vs Compra</button>
      <button class="sb-link" onclick="nav('quitar', this)">üéØ Quitar em X anos</button>
      <button class="sb-link" onclick="nav('investsacar', this)">üîÑ Investir ‚Üí Sacar ‚Üí Amortizar</button>
    </div>
  </div>
</nav>

<div class="container">

  <div id="tab-simulador" class="tab-panel active">
    <div class="card">
      <div class="card-header"><div class="card-title"><i>üìã</i> Simulador de Financiamento</div></div>
      <div class="grid grid-3">
        <div class="input-group">
          <label>Valor (R$)</label>
          <input type="number" id="simValor" value="300000" oninput="calcSimulador()">
        </div>
        <div class="input-group">
          <label>Taxa Anual (%)</label>
          <input type="number" id="simTaxa" value="9.5" step="0.1" oninput="calcSimulador()">
        </div>
        <div class="input-group">
          <label>Prazo (anos)</label>
          <input type="number" id="simPrazo" value="30" oninput="calcSimulador()">
        </div>
        <div class="input-group">
          <label>Sistema</label>
          <select id="simSys" onchange="calcSimulador()">
            <option value="price">PRICE (Parcela Fixa)</option>
            <option value="sac">SAC (Amort. Fixa)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="kpi-row">
      <div class="kpi green"><div class="kpi-label">Primeira Parcela</div><div class="kpi-val" id="kpiSimParcela">R$ 0,00</div></div>
      <div class="kpi blue"><div class="kpi-label">Total Pago</div><div class="kpi-val" id="kpiSimTotal">R$ 0,00</div></div>
      <div class="kpi"><div class="kpi-label">Juros Totais</div><div class="kpi-val" id="kpiSimJuros" style="color:var(--danger)">R$ 0,00</div></div>
    </div>

    <div class="card">
      <div class="table-container" style="max-height:400px;">
        <table id="tableSim"><thead><tr><th>M√™s</th><th>Parcela</th><th>Amortiza√ß√£o</th><th>Juros</th><th>Saldo Devedor</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

  <div id="tab-comparativo" class="tab-panel">
    <div class="card">
      <div class="card-header"><div class="card-title"><i>üìä</i> Investir ou Amortizar?</div></div>
      <p style="color:var(--text-muted)">Compare a taxa efetiva do seu financiamento com o rendimento l√≠quido da Selic.</p>
      <br>
      <div class="grid grid-2">
         <div class="input-group"><label>Juros D√≠vida (%)</label><input type="number" id="cmpDiv" value="9.5" oninput="calcComparativo()"></div>
         <div class="input-group"><label>Selic Meta (%)</label><input type="number" id="cmpSelic" value="13.75" oninput="calcComparativo()"></div>
      </div>
      <div class="kpi-row" style="margin-top:20px">
         <div class="kpi"><div class="kpi-label">Veredito</div><div class="kpi-val" id="cmpVerdict">--</div></div>
      </div>
    </div>
  </div>

  <div id="tab-oportunidade" class="tab-panel"><div class="card"><h3>Em constru√ß√£o...</h3></div></div>
  <div id="tab-aluguel" class="tab-panel"><div class="card"><h3>Em constru√ß√£o...</h3></div></div>
  <div id="tab-quitar" class="tab-panel"><div class="card"><h3>Em constru√ß√£o...</h3></div></div>

  <div id="tab-investsacar" class="tab-panel">
    
    <div style="margin-bottom:20px;">
      <h2 style="color:var(--text); font-size:1.5rem; margin-bottom:5px;">Investir ‚Üí Sacar ‚Üí Amortizar (Ciclos)</h2>
      <p style="color:var(--text-muted); font-size:0.9rem;">Estrat√©gia de m√∫ltiplos ciclos: investe na Selic durante N meses, saca o montante com juros compostos l√≠quidos e amortiza o financiamento. Cada ciclo reduz o saldo devedor e os juros futuros.</p>
    </div>

    <div class="card">
      
      <div class="is-section-title">üè¶ Financiamento</div>
      <div class="grid grid-3">
        <div class="input-group">
          <label>Valor do Financiamento (R$)</label>
          <input type="number" id="isValor" value="300000" placeholder="Ex: 300000" oninput="prevIS()">
          <div class="helper">ex: 300000 = R$ 300.000,00</div>
        </div>
        <div class="input-group">
          <label>Taxa do Financiamento (% a.a.)</label>
          <input type="number" id="isTaxa" value="9.5" step="0.1" placeholder="Ex: 9.5" oninput="prevIS()">
          <div class="helper">Digite s√≥ o n√∫mero (ex: 9.5)</div>
        </div>
        <div class="input-group">
          <label>Prazo (anos)</label>
          <input type="number" id="isPrazo" value="30" placeholder="Ex: 30" oninput="prevIS()">
        </div>
        <div class="input-group">
          <label>Sistema de Amortiza√ß√£o</label>
          <select id="isSys" onchange="prevIS()">
            <option value="price">PRICE ‚Äî parcela fixa</option>
            <option value="sac">SAC ‚Äî amortiza√ß√£o fixa</option>
          </select>
        </div>
      </div>
      <div class="is-preview-box">
        <span>üìã Parcela estimada (inicial):</span>
        <span class="val" id="isPrevParcela">R$ 2.521,60</span>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:25px 0;">

      <div class="is-section-title">üí∞ Par√¢metros do Investimento</div>
      <div class="grid grid-3">
        <div class="input-group">
          <label>Aporte Mensal (R$)</label>
          <input type="number" id="isAporte" value="2000" oninput="prevIS()">
          <div class="helper">ex: 2000 = R$ 2.000,00/m√™s</div>
        </div>
        <div class="input-group">
          <label>Selic esperada (% a.a.)</label>
          <input type="number" id="isSelic" value="13.75" step="0.1" oninput="prevIS()">
          <div class="helper">Digite s√≥ o n√∫mero (ex: 13.75)</div>
        </div>
        <div class="input-group">
          <label>IR sobre Rendimento (%)</label>
          <input type="number" id="isIR" value="15" oninput="prevIS()">
          <div class="helper">Incide s√≥ sobre o ganho</div>
        </div>
        <div class="input-group">
          <label>Tipo de Investimento</label>
          <select disabled style="opacity:0.7"><option>Selic l√≠quido (CDB / LCI)</option></select>
          <div class="helper">Rendimento atrelado √† Selic com IR</div>
        </div>
      </div>
      <div class="is-preview-box">
        <div>
          <div style="font-size:0.8rem; color:var(--text-muted)">üìà Taxa l√≠quida mensal aprox:</div>
          <div class="val" style="font-size:1rem" id="isPrevTaxa">0,92% a.m.</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:0.8rem; color:var(--text-muted)">Montante ap√≥s 12 meses:</div>
          <div class="val" style="font-size:1rem" id="isPrevMontante">R$ 25.480,00</div>
        </div>
      </div>

      <hr style="border:0; border-top:1px solid var(--border); margin:25px 0;">

      <div class="is-section-title">üîÑ Ciclos de Investimento</div>
      <div class="grid grid-2">
        <div class="input-group">
          <label>Quantos ciclos?</label>
          <input type="number" id="isCiclos" value="5" oninput="prevIS()">
        </div>
        <div class="input-group">
          <label>Dura√ß√£o de cada ciclo (meses)</label>
          <input type="number" id="isDuracao" value="24" oninput="prevIS()">
          <div class="helper">ex: 24 = investe 2 anos, saca e paga</div>
        </div>
      </div>
      <div class="is-preview-box" style="border-color:var(--accent2)">
        <span>üïê Dura√ß√£o total da estrat√©gia:</span>
        <span class="val" style="color:var(--accent2)" id="isPrevTotalTempo">120 meses (10 anos)</span>
      </div>

      <button class="btn-simulate" onclick="runInvestSacar()">üöÄ Simular Estrat√©gia</button>
    </div>

    <div class="card" id="resIS" style="display:none; border-color:var(--accent);">
      <div class="card-header"><div class="card-title"><i>üèÅ</i> Resultado da Estrat√©gia</div></div>
      <div class="kpi-row">
        <div class="kpi blue"><div class="kpi-label">D√≠vida Original</div><div class="kpi-val" id="resIsDiv">R$ 300k</div></div>
        <div class="kpi green"><div class="kpi-label">Amortizado via Inv.</div><div class="kpi-val" id="resIsAmort">R$ 0</div></div>
        <div class="kpi"><div class="kpi-label">Tempo Economizado</div><div class="kpi-val" id="resIsTempo" style="color:var(--accent)">0 meses</div></div>
      </div>
      <canvas id="chartIS" style="max-height:300px; margin-bottom:20px;"></canvas>
      <h4 style="color:var(--text-muted); font-size:0.85rem; text-transform:uppercase; margin-bottom:10px;">Log de Ciclos</h4>
      <div class="cycle-log" id="isLog"></div>
    </div>

    <div class="how-it-works">
      <div class="how-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display==='none'?'block':'none'">
        <span>‚ñ∂ Como funciona o c√°lculo? (Juros Compostos)</span>
      </div>
      <div class="how-content" style="display:block"> <p>O investimento acumula com <strong>juros compostos</strong>: cada m√™s o aporte se soma ao saldo anterior e <strong>todo</strong> o saldo rende novamente. O IR √© descontado apenas sobre o rendimento mensal.</p>
        
        <div class="formula-box">
          Montante<sub>m</sub> = (Montante<sub>m-1</sub> + Aporte) √ó (1 + i<sub>l√≠q</sub>)
        </div>

        <ul class="step-list">
          <li data-step="1">
            <strong>Taxa mensal bruta:</strong> i<sub>bruto</sub> = (1 + Selic)<sup>1/12</sup> ‚àí 1<br>
            Converte a taxa Selic anual para equivalente mensal.
          </li>
          <li data-step="2">
            <strong>Desconta o IR:</strong> i<sub>l√≠q</sub> = i<sub>bruto</sub> √ó (1 ‚àí IR%)<br>
            O IR incide s√≥ sobre o ganho.
          </li>
          <li data-step="3">
            <strong>Acumula√ß√£o:</strong><br>
            M√™s 1: (0 + Aporte) √ó (1 + i<sub>l√≠q</sub>)<br>
            M√™s 2: (M√™s 1 + Aporte) √ó (1 + i<sub>l√≠q</sub>)
          </li>
          <li data-step="4">
            <strong>Saque e Amortiza√ß√£o:</strong><br>
            No fim do ciclo, o montante total abate o Saldo Devedor. O saldo cai, e os juros futuros tamb√©m.
          </li>
          <li data-step="5">
            <strong>Novo Ciclo:</strong><br>
            Come√ßa do zero no investimento, mas a d√≠vida agora √© menor.
          </li>
        </ul>

        <div class="example-box">
          <strong>Exemplo:</strong> Aporte R$ 2.000, Selic 13,75%, IR 15%. Taxa l√≠q ‚âà 0,92%.<br>
          Em 24 meses acumula ‚âà <strong>R$ 53.900</strong>. Esse valor reduz direto o saldo devedor.
        </div>
      </div>
    </div>

  </div>

</div>

<script>
/* ‚îÄ‚îÄ‚îÄ GLOBAL & HELPERS ‚îÄ‚îÄ‚îÄ */
let _exportData = { headers:[], rows:[], filename:'calculo' };
function fmt(n) { return n.toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtR(n) { return 'R$ ' + fmt(n); }

// Toggle Sidebar
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
  document.getElementById('sbOverlay').classList.toggle('open');
}

// Navigation
function nav(tabId, btn) {
  // UI Update
  document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-'+tabId).classList.add('active');
  
  // Menu Active State
  document.querySelectorAll('.sb-link').forEach(l => l.classList.remove('active'));
  if(btn) btn.classList.add('active');

  // Close sidebar on mobile
  if(window.innerWidth < 1000) toggleSidebar();

  // Trigger default calcs
  if(tabId === 'simulador') calcSimulador();
  if(tabId === 'investsacar') prevIS();
}

// Export Menu
function toggleExport() {
  const m = document.getElementById('exportMenu');
  m.classList.toggle('open');
}
document.addEventListener('click', (e) => {
  if(!e.target.closest('.export-wrap')) document.getElementById('exportMenu').classList.remove('open');
});

/* ‚îÄ‚îÄ‚îÄ LOGIC: SIMULADOR (ABA 1) ‚îÄ‚îÄ‚îÄ */
function calcSimulador() {
  const V = parseFloat(document.getElementById('simValor').value)||0;
  const tA = parseFloat(document.getElementById('simTaxa').value)||0;
  const prazoA = parseFloat(document.getElementById('simPrazo').value)||0;
  const sys = document.getElementById('simSys').value;
  const n = prazoA * 12;
  const i = (Math.pow(1 + tA/100, 1/12) - 1);

  if(V <= 0 || n <= 0) return;

  let saldo = V;
  let totalPago = 0;
  let totalJuros = 0;
  let rows = [];

  // Price Base Pmt
  let pmtPrice = V * (i * Math.pow(1+i,n)) / (Math.pow(1+i,n) - 1);
  let amSac = V / n;

  for(let m=1; m<=n; m++) {
    let juros = saldo * i;
    let parc = 0, amort = 0;

    if(sys === 'price') {
      parc = pmtPrice;
      amort = parc - juros;
    } else {
      amort = amSac;
      parc = amort + juros;
    }

    if(saldo < amort) { amort = saldo; parc = amort + juros; }
    saldo -= amort;
    totalPago += parc;
    totalJuros += juros;

    if(m <= 12 || m % 12 === 0 || saldo === 0) { // Limit table rows for DOM perf
       // We only show summary in UI, but calculate all
    }
    rows.push({m, p:parc, a:amort, j:juros, s:saldo});
    if(saldo < 0.01) break;
  }

  // Update UI
  document.getElementById('kpiSimParcela').textContent = fmtR(rows[0].p);
  document.getElementById('kpiSimTotal').textContent = fmtR(totalPago);
  document.getElementById('kpiSimJuros').textContent = fmtR(totalJuros);

  const tbody = document.querySelector('#tableSim tbody');
  tbody.innerHTML = rows.slice(0, 60).map(r => 
    `<tr><td>${r.m}</td><td>${fmtR(r.p)}</td><td>${fmtR(r.a)}</td><td>${fmtR(r.j)}</td><td>${fmtR(r.s)}</td></tr>`
  ).join('') + (rows.length > 60 ? '<tr><td colspan="5">... (mostrando apenas primeiros 60 meses)</td></tr>' : '');

  // Prepare Export
  _exportData = {
    filename: 'simulacao_financiamento',
    headers: ['Mes', 'Parcela', 'Amortizacao', 'Juros', 'Saldo Devedor'],
    rows: rows.map(r => [r.m, r.p, r.a, r.j, r.s])
  };
}

/* ‚îÄ‚îÄ‚îÄ LOGIC: COMPARATIVO (ABA 2 - SIMPLES) ‚îÄ‚îÄ‚îÄ */
function calcComparativo() {
  const iDiv = parseFloat(document.getElementById('cmpDiv').value);
  const iSel = parseFloat(document.getElementById('cmpSelic').value);
  const el = document.getElementById('cmpVerdict');
  // Simplificado: Selic Liq aprox (IR 15%)
  const selLiq = iSel * 0.85; 
  if(selLiq > iDiv) {
    el.textContent = "INVESTIR (Selic L√≠q > Juros D√≠vida)";
    el.style.color = "var(--accent)";
  } else {
    el.textContent = "AMORTIZAR (Juros D√≠vida > Selic)";
    el.style.color = "var(--danger)";
  }
}

/* ‚îÄ‚îÄ‚îÄ LOGIC: INVESTIR -> SACAR (ABA 6 - COMPLEXA) ‚îÄ‚îÄ‚îÄ */
let chartISRef = null;

function prevIS() {
  const V = parseFloat(document.getElementById('isValor').value)||0;
  const p = (parseFloat(document.getElementById('isPrazo').value)||0)*12;
  const ta = parseFloat(document.getElementById('isTaxa').value)||0;
  const sys = document.getElementById('isSys').value;
  const aporte = parseFloat(document.getElementById('isAporte').value)||0;
  const selic = parseFloat(document.getElementById('isSelic').value)||0;
  const ir = parseFloat(document.getElementById('isIR').value)||0;
  const ciclos = parseFloat(document.getElementById('isCiclos').value)||0;
  const duracao = parseFloat(document.getElementById('isDuracao').value)||0;

  // 1. Parcela Financiamento
  const i = (Math.pow(1 + ta/100, 1/12) - 1);
  let parc = 0;
  if(sys === 'price') parc = V * (i * Math.pow(1+i,p)) / (Math.pow(1+i,p) - 1);
  else parc = (V/p) + (V*i);
  document.getElementById('isPrevParcela').textContent = fmtR(parc);

  // 2. Investimento Previa
  const iBruto = Math.pow(1 + selic/100, 1/12) - 1;
  const iLiq = iBruto * (1 - ir/100);
  document.getElementById('isPrevTaxa').textContent = (iLiq*100).toFixed(2) + '% a.m.';
  
  // FV 12 meses
  let fv = 0;
  for(let m=0; m<12; m++) fv = (fv + aporte) * (1 + iLiq);
  document.getElementById('isPrevMontante').textContent = fmtR(fv);

  // 3. Tempo Total
  const mesesTot = ciclos * duracao;
  const anosTot = mesesTot / 12;
  document.getElementById('isPrevTotalTempo').textContent = `${mesesTot} meses (${anosTot.toFixed(1)} anos)`;
}

function runInvestSacar() {
  const V = parseFloat(document.getElementById('isValor').value);
  const prazoMeses = parseFloat(document.getElementById('isPrazo').value)*12;
  const tAnual = parseFloat(document.getElementById('isTaxa').value);
  const sys = document.getElementById('isSys').value;
  
  const aporte = parseFloat(document.getElementById('isAporte').value);
  const selic = parseFloat(document.getElementById('isSelic').value);
  const ir = parseFloat(document.getElementById('isIR').value);
  
  const numCiclos = parseInt(document.getElementById('isCiclos').value);
  const mesesCiclo = parseInt(document.getElementById('isDuracao').value);

  // Taxas
  const iFin = Math.pow(1 + tAnual/100, 1/12) - 1;
  const iInv = (Math.pow(1 + selic/100, 1/12) - 1) * (1 - ir/100);

  let saldoDev = V;
  let saldoInv = 0;
  let logHtml = '';
  let totalAmortizadoViaInvest = 0;
  
  let chartLabels = [];
  let chartDataDev = [];
  let chartDataInv = [];
  let exportRows = [];

  let mesAtual = 0;

  for(let c=1; c<=numCiclos; c++) {
    if(saldoDev <= 1) break;

    // Inicio ciclo
    let amSac = 0, pmtPrice = 0;
    // Simplificacao: recalcula parcela baseada no saldo atual e prazo restante
    let prazoRestante = prazoMeses - mesAtual;
    if(sys === 'sac') amSac = saldoDev / prazoRestante;
    else pmtPrice = saldoDev * (iFin * Math.pow(1+iFin,prazoRestante))/(Math.pow(1+iFin,prazoRestante)-1);

    // Roda meses do ciclo
    for(let m=0; m<mesesCiclo; m++) {
      if(saldoDev <= 1) break;
      mesAtual++;

      // 1. Paga parcela normal
      let juros = saldoDev * iFin;
      let amort = sys === 'sac' ? amSac : (pmtPrice - juros);
      saldoDev -= amort;
      
      // 2. Investe
      saldoInv = (saldoInv + aporte) * (1 + iInv);

      // Data Chart (a cada 6 meses ou fim de ciclo pra nao pesar)
      if(m === mesesCiclo-1 || mesAtual % 6 === 0) {
        chartLabels.push('M'+mesAtual);
        chartDataDev.push(saldoDev);
        chartDataInv.push(saldoInv);
      }
      exportRows.push([c, mesAtual, saldoDev, saldoInv, 'Acumulando']);
    }

    // Fim do ciclo: Saca e Amortiza
    if(saldoDev > 0) {
      let valorAbater = saldoInv;
      if(valorAbater > saldoDev) valorAbater = saldoDev; // Quita tudo
      
      saldoDev -= valorAbater;
      totalAmortizadoViaInvest += valorAbater;
      
      logHtml += `<div class="cycle-item">
        <span>Ciclo ${c} (M√™s ${mesAtual})</span>
        <span>Saque: ${fmtR(saldoInv)} ‚ûî Saldo Restante: ${fmtR(saldoDev)}</span>
      </div>`;

      exportRows.push([c, mesAtual, saldoDev, 0, `Saque de ${fmtR(saldoInv)}`]);
      saldoInv = 0; // Zerou conta inv
      
      // Update chart pos saque
      chartLabels.push('M'+mesAtual+' (Saque)');
      chartDataDev.push(saldoDev);
      chartDataInv.push(0);
    }
  }

  // Exibir Resultados
  document.getElementById('resIS').style.display = 'block';
  document.getElementById('resIsDiv').textContent = fmtR(V);
  document.getElementById('resIsAmort').textContent = fmtR(totalAmortizadoViaInvest);
  document.getElementById('isLog').innerHTML = logHtml;
  
  // Scroll
  document.getElementById('resIS').scrollIntoView({behavior:'smooth'});

  // Chart
  if(chartISRef) chartISRef.destroy();
  const ctx = document.getElementById('chartIS').getContext('2d');
  chartISRef = new Chart(ctx, {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [
        { label: 'Saldo Devedor', data: chartDataDev, borderColor: '#ef5350', fill:true, backgroundColor:'rgba(239,83,80,0.1)' },
        { label: 'Investimento Acumulado', data: chartDataInv, borderColor: '#00d4aa', backgroundColor:'rgba(0,212,170,0.1)' }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: 'index', intersect: false },
      scales: {
        x: { grid: { color: '#252838' }, ticks:{ color:'#7a7f95'} },
        y: { grid: { color: '#252838' }, ticks:{ color:'#7a7f95'} }
      },
      plugins: { legend: { labels: { color: '#e2e4ea' } } }
    }
  });

  // Atualizar Global Export
  _exportData = {
    filename: 'estrategia_ciclos',
    headers: ['Ciclo', 'Mes Global', 'Saldo Devedor', 'Saldo Investido', 'Evento'],
    rows: exportRows
  };
}


/* ‚îÄ‚îÄ‚îÄ EXPORT FUNCTIONS (CSV & EXCEL XML) ‚îÄ‚îÄ‚îÄ */
function exportCSV() {
  if(!_exportData.rows.length) return alert("Sem dados para exportar.");
  let csv = "\uFEFF" + _exportData.headers.join(";") + "\n";
  _exportData.rows.forEach(r => {
    csv += r.map(c => (typeof c === 'number' ? c.toFixed(2).replace('.',',') : c)).join(";") + "\n";
  });
  downloadFile(_exportData.filename + ".csv", csv, "text/csv;charset=utf-8");
}

function exportExcelXML() {
  if(!_exportData.rows.length) return alert("Sem dados para exportar.");
  let xml = '<?xml version="1.0"?><?mso-application progid="Excel.Sheet"?>';
  xml += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet">';
  xml += '<Styles><Style ss:ID="hdr"><Font ss:Bold="1" ss:Color="#FFFFFF"/><Interior ss:Color="#161822" ss:Pattern="Solid"/></Style></Styles>';
  xml += '<Worksheet ss:Name="Sheet1"><Table>';
  
  // Header
  xml += '<Row>';
  _exportData.headers.forEach(h => xml += `<Cell ss:StyleID="hdr"><Data ss:Type="String">${h}</Data></Cell>`);
  xml += '</Row>';
  
  // Rows
  _exportData.rows.forEach(r => {
    xml += '<Row>';
    r.forEach(c => {
      let type = typeof c === 'number' ? 'Number' : 'String';
      xml += `<Cell><Data ss:Type="${type}">${c}</Data></Cell>`;
    });
    xml += '</Row>';
  });
  xml += '</Table></Worksheet></Workbook>';
  downloadFile(_exportData.filename + ".xml", xml, "application/vnd.ms-excel");
}

function downloadFile(name, content, type) {
  const blob = new Blob([content], {type: type});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

// Init
nav('simulador'); // Start
</script>
</body>
</html>
